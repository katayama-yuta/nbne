# nbneにテスト用のNotion APIキーを設定する

このドキュメントではnbne上でAPIクライアントをテストするために必要な、Notion APIキーの取得・設定手順を説明します。大まかな流れは以下の通りです。

1. インテグレーションを作成する
2. テスト用にAPIキーを設定する
3. コネクトを追加する
4. APIキーが設定できたことを確認する

## インテグレーションを作成する

はじめに、連携したいワークスペースに対してインテグレーションを作成し、APIキーを発行します。下記ページにアクセスしてください。

- [https://www.notion.com/my-integrations](https://www.notion.com/my-integrations)

ページを開いたら「新しいインテグレーションを作成する」をクリックしてください。

![add-integration](https://github.com/katayama-yuta/nbne/assets/126459823/2cba2012-8501-4e08-a89d-9f20735e7a17)

関連ワークスペースのドロップダウンから連携したいワークスペースを選択し、名前に「nbne」を入力、右下の「送信」ボタンをクリックしてインテグレーションを作成してください。

![integration-form](https://github.com/katayama-yuta/nbne/assets/126459823/92a9ddee-a322-40e8-8d43-69935332d906)

次の画面で表示される内部インテグレーションシークレット（こちらがNotion APIキーに該当します）は、nbneからNotion APIに対してリクエストを行うために必要となります。右側の「表示」をクリックし、内容をクリップボードにコピーしてください。

**シークレットキーは他の人と共有しないよう注意しましょう。** 万が一外部に漏れた可能性がある場合は、すぐにシークレットキーの更新を行なってください。

以上でインテグレーションの作成は完了です。

## テスト用にAPIキーを設定する

開発時にAPIクライアントをテストできるよう、取得したAPIキーをnbneに設定していきます。

`.env`ファイルをnbneのルート直下に作成してください。

```shell
$ touch .env
```

エディタで`.env`ファイルを開き、以下の行を追加してください。`YOUR_API_KEY`の部分は、前節でコピーした内部インテグレーションシークレットに置き換えましょう。

```config
NOTION_API_KEY=YOUR_API_KEY
```

ファイルを保存すれば設定完了です。APIクライアントのテスト時、プログラムはここで設定した値を環境変数として読み取り、HTTPリクエストの認証に利用します。

このファイルは **絶対にバージョン管理の対象に含めないでください。** 誤ってリモートリポジトリにプッシュしてしまうと、第三者が勝手にワークスペースの情報を読み取ったり、書き換えてしまう可能性があります（既に`.gitignore`に追加されているため、通常このファイルが追跡の対象となることはありません）。

## コネクトを追加する

作成したインテグレーションの利用を開始するには、Notionの特定のページにコネクトとして追加を行う必要があります。Notion側で連携を行いたいページを開いてください。その後右上の「...」をクリックし、メニュー下部の「＋ コネクトの追加」を選択しましょう。

「コネクトを探す...」にnbneと入力すると、作成したインテグレーションが表示されるためクリックしてください。

![connect-nbne](https://github.com/katayama-yuta/nbne/assets/126459823/d6f06106-5ff2-4703-9a80-b9eb35bdc7f8)

連携の確認を行うダイアログが表示されるため、内容をチェックし「はい」を選択してください。

これで連携は完了です。APIクライアントはコネクトに追加されたページ（とその配下のページやDB）に対してデータの取得や作成ができるようになります。

## APIキーが設定できたことを確認する

APIキーの設定ができたことを確認するため、下記コマンドでページ・DB情報が取得できることを確認しましょう。

```shell
$ python src/api/notion.py
```

エラーなく一覧情報が取得できていればOKです。
